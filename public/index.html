<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENDPRO - NFT Mint</title>
    
 <!-- Farcaster Frame Meta Tags -->
<meta property="fc:frame" content="vNext" />
<meta property="fc:frame:image" content="https://gateway.pinata.cloud/ipfs/bafybeiaewipv4zf7votgkjfizmgmat6k6jjz4ofun5ia2nyncfr2vvmibe/active.png" />
<meta property="fc:frame:image:aspect_ratio" content="1:1" />
<meta property="fc:frame:button:1" content="Mint ENDPRO NFT" />
<meta property="fc:frame:button:1:action" content="link" />
<meta property="fc:frame:button:1:target" content="https://endpro-miniapp.vercel.app" />



    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- Farcaster Frame SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@latest/dist/index.js"></script>


    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        h1 {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .info-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }

        .label {
            color: #666;
        }

        .value {
            font-weight: bold;
            color: #333;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .wallet-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            color: #0066cc;
        }

        .hidden {
            display: none;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ENDPRO</h1>
        <p class="subtitle">Dynamic NFT on Base</p>

        <!-- Connect Screen -->
        <div id="connectScreen">
            <p style="margin: 20px 0;">Connect your wallet to mint ENDPRO NFT</p>
            <button class="btn-primary" onclick="connectWallet()">Connect Wallet</button>
        </div>

        <!-- Main Screen (hidden by default) -->
        <div id="mainScreen" class="hidden">
            <div class="wallet-info" id="walletAddress"></div>

            <div class="info-box">
                <div class="info-item">
                    <span class="label">Network:</span>
                    <span class="value">Base Mainnet</span>
                </div>
                <div class="info-item">
                    <span class="label">Price:</span>
                    <span class="value" id="mintPrice">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="label">Total Minted:</span>
                    <span class="value" id="totalMinted">0</span>
                </div>
            </div>

            <div id="statusMessage"></div>

            <button id="mintBtn" class="btn-primary" onclick="mintNFT()" disabled>
                Mint NFT
            </button>

            <button class="btn-secondary" onclick="disconnect()">
                Disconnect
            </button>
        </div>

        <!-- Loading -->
        <div id="loader" class="hidden">
            <div class="loader"></div>
            <p id="loaderText">Processing...</p>
        </div>
    </div>

    <script>
    // Configuration
    const CONTRACT_ADDRESS = '0x7c17be91D29e867F90F47Dc53B7d8c6E63e4c7c4'; // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û
    const CHAIN_ID = 8453; // Base Mainnet
    const CONTRACT_ABI = [
        "function safeMint() external payable",
        "function mintPrice() external view returns (uint256)",
        "function balanceOf(address) external view returns (uint256)",
        "function totalSupply() external view returns (uint256)"
    ];

    // State
    let userAddress = null;
    let contract = null;
    let provider = null;
    let signer = null;
    let userFid = null;

// Farcaster Frame context
let frameContext = null; // ‚Üê –ù–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø

// Initialize Farcaster Frame
async function initFrame() { // ‚Üê –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø (–≤–µ—Å—å –±–ª–æ–∫)
    try {
        if (typeof window.FrameSDK !== 'undefined') {
            await window.FrameSDK.ready();
            window.FrameSDK.actions.ready();
            frameContext = await window.FrameSDK.context();
            
            if (frameContext?.user?.fid) {
                userFid = frameContext.user.fid;
                console.log('‚úÖ Farcaster FID:', userFid);
            }
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Not running in Farcaster Frame:', error);
    }
}
    // Connect Wallet
    async function connectWallet() {
        try {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or Rabby Wallet!');
                return;
            }

            showLoader('Connecting wallet...');

            const accounts = await window.ethereum.request({ 
                method: 'eth_requestAccounts' 
            });

            userAddress = accounts[0];
            console.log('Connected:', userAddress);

            // Check network
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== '0x2105') {
                hideLoader();
                alert('Please switch to Base Mainnet!');
                return;
            }

            // Setup provider and contract
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            hideLoader();
            showMainScreen();
            await loadContractInfo();
            await checkEligibility();

        } catch (error) {
            hideLoader();
            console.error('Connection error:', error);
            alert('Failed to connect: ' + error.message);
        }
    }

    // Show main screen
    function showMainScreen() {
        document.getElementById('connectScreen').classList.add('hidden');
        document.getElementById('mainScreen').classList.remove('hidden');
        document.getElementById('walletAddress').textContent = 
            `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
    }

    // Load contract info
    async function loadContractInfo() {
        try {
            const [price, supply] = await Promise.all([
                contract.mintPrice(),
                contract.totalSupply()
            ]);

            document.getElementById('mintPrice').textContent = 
                ethers.utils.formatEther(price) + ' ETH';
            document.getElementById('totalMinted').textContent = supply.toString();

        } catch (error) {
            console.error('Failed to load contract info:', error);
            document.getElementById('mintPrice').textContent = '0.00033 ETH';
        }
    }

 async function checkEligibility() {
    try {
        console.log('üîç Checking eligibility...');
        
        const statusDiv = document.getElementById('statusMessage');
        const mintBtn = document.getElementById('mintBtn');

        // –ö–†–ò–¢–ò–ß–ù–û: –¢—Ä–µ–±—É–µ–º Farcaster Frame
        if (!userFid) {
            statusDiv.innerHTML = '<div class="status error">‚ùå This app must be opened from Warpcast Frame to verify PRO subscription</div>';
            mintBtn.disabled = true;
            console.log('‚ö†Ô∏è No Farcaster FID detected');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∂–µ –∑–∞–º–∏–Ω—Ç–∏–ª –∏–ª–∏ –Ω–µ—Ç
        const endproBalance = await contract.balanceOf(userAddress);
        console.log('‚úÖ ENDPRO balance:', endproBalance.toString());

        if (endproBalance.gt(0)) {
            statusDiv.innerHTML = '<div class="status success">‚úÖ You already minted ENDPRO NFT!</div>';
            mintBtn.disabled = true;
            return;
        }
        
        console.log('üîç Checking PRO subscription for FID:', userFid);
        statusDiv.innerHTML = '<div class="status warning">‚è≥ Verifying Farcaster PRO subscription...</div>';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º PRO –ø–æ–¥–ø–∏—Å–∫—É
        const response = await fetch('https://endpro-miniapp.vercel.app/api/check-eligibility', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fid: userFid })
        });

        const data = await response.json();
        console.log('‚úÖ Backend response:', data);

        if (data.hasPro) {
            statusDiv.innerHTML = '<div class="status success">‚úÖ Farcaster PRO verified! You can mint.</div>';
            mintBtn.disabled = false;
        } else {
            statusDiv.innerHTML = '<div class="status error">‚ùå Farcaster PRO subscription required. Get it at warpcast.com/~/settings</div>';
            mintBtn.disabled = true;
        }

    } catch (error) {
        console.error('‚ùå Eligibility check error:', error);
        document.getElementById('statusMessage').innerHTML = 
            '<div class="status error">‚ö†Ô∏è Failed to verify eligibility. Please try again.</div>';
        document.getElementById('mintBtn').disabled = true;
    }
}




    // Mint NFT
    async function mintNFT() {
        try {
            showLoader('Preparing transaction...');

            const mintPrice = await contract.mintPrice();
            console.log('üí∞ Mint price:', ethers.utils.formatEther(mintPrice), 'ETH');

            showLoader('Confirm transaction in wallet...');

            const tx = await contract.safeMint({ 
                value: mintPrice,
                gasLimit: 200000
            });
            
            console.log('‚úÖ Transaction sent:', tx.hash);

            showLoader('Waiting for confirmation...');

            const receipt = await tx.wait();
            console.log('‚úÖ Transaction confirmed!', receipt);

            hideLoader();
            alert('üéâ NFT minted successfully!\n\nTransaction: ' + tx.hash);

            // Reload page
            window.location.reload();

        } catch (error) {
            hideLoader();
            console.error('‚ùå Mint error:', error);

            if (error.code === 4001) {
                alert('Transaction cancelled');
            } else if (error.code === -32000) {
                alert('Insufficient funds for gas + value');
            } else {
                alert('Mint failed: ' + error.message);
            }
        }
    }

    // Disconnect
    function disconnect() {
        userAddress = null;
        contract = null;
        provider = null;
        signer = null;

        document.getElementById('mainScreen').classList.add('hidden');
        document.getElementById('connectScreen').classList.remove('hidden');
    }

    // Loader functions
    function showLoader(text) {
        document.getElementById('loaderText').textContent = text;
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('connectScreen').classList.add('hidden');
        document.getElementById('mainScreen').classList.add('hidden');
    }

    function hideLoader() {
        document.getElementById('loader').classList.add('hidden');
    }

    // Check if already connected on page load
    window.addEventListener('load', async () => {
    await initFrame();
        if (typeof window.ethereum !== 'undefined') {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            
            if (accounts.length > 0) {
                userAddress = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                showMainScreen();
                await loadContractInfo();
                await checkEligibility();
            }
        }
    });

    // Handle account changes
    if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts.length === 0) {
                disconnect();
            } else {
                window.location.reload();
            }
        });

        window.ethereum.on('chainChanged', () => {
            window.location.reload();
        });
    }
</script>

</body>
</html>
